Let $r_{p,i}$ denote a linear ring belonging to a polygon denoted as $P_p$.
The symbol $p$ denotes the \textit{polygon index}, while $i$ denotes the \textit{ring index}.
A ring index of 1 indicates an \textit{exterior ring}, while a ring index of greater than one represents an interior ring.
The polygon $P_p$ can therefore be represented as a sequence of $|P_p| \geq 1$ linear rings,
%
\begin{equation*}
P_p = \{ r_{p,1}, \dots, r_{p, |P_p|}\}
\end{equation*}
%
Linear rings are represented as ordered sequences of $(x, y, z)$ coordinate tuples, assuming that the associated polygon is three-dimensional.
The linear ring can therefore be denoted as
%
\begin{equation*}
  r_{p,i}
  =
  \{
    (x_{p,i,1}, y_{p,i,1}, z_{p,i,1}),
    \dots,
    (x_{p,i,|r_{p, i}|}, y_{p,i,|r_{p, i}|}, z_{p,i,|r_{p, i}|}),
    (x_{p,i,1}, y_{p,i,1}, z_{p,i,1})
  \},
\end{equation*}
%
where the first and last coordinate tuple are identical in order to close the ring.
Now assume that the polygon collection at hand contains three-dimensional polygons which are all approximately planar.
Any $(x, y, z)$ vertex must therefore satisfy the following relationship:
%
\begin{equation*}
  z = \beta_{p,0} + \beta_{p,x} x + \beta_{p,y} y + \varepsilon
\end{equation*}
%
Where $\varepsilon$ is error term due to measurement errors or other type of random data errors.
The distribution of $\varepsilon$ must be investigated further for our dataset, but for the moment assume the error to be normally distributed with zero mean and some unknown variance $\sigma^2$, i.e. $\varepsilon \sim \mathcal{N}(0, \sigma^2)$.
%
The task is now to determine the coefficient vector $\vec{\beta}_p = {[\beta_{p,0}, \beta_{p,x}, \beta_{p,y}]}^T$ which describes the planar polygon surface.
We construct a design matrix $X_p$ consisting of all $(x, y)$ vertex coordinate tuples of the given polygon $P_p$:
%
\begin{equation*}
  X_p
  =
  \begin{bmatrix}
    1 & x_{p,1,1} & y_{p,1,1} \\
    1 & x_{p,1,2} & y_{p,1,2} \\
    \vdots & \vdots & \vdots \\
    1 & x_{p,1,|r_{p,1}|} & y_{p,1,|r_{p,1}|} \\
    1 & x_{p,2,1} & y_{p,2,1} \\
    1 & x_{p,2,2} & y_{p,2,2} \\
    \vdots & \vdots & \vdots \\
    1 & x_{p,|P_p|,|r_{|P_p|}|} & y_{p,|P_p|,|r_{|P_p|}|} \\
  \end{bmatrix}.
\end{equation*}
%
Likewise, a response vector $\vec{z}_p$ is constructed consisting of the respective elevation values associated with the $(x, y)$ tuples:
%
\begin{equation*}
  \vec{z}_p
  =
  \begin{bmatrix}
     z_{p,1,1} \\
     z_{p,1,2} \\
     \vdots \\
     z_{p,1,|r_{p,1}|} \\
     z_{p,2,1} \\
     z_{p,2,2} \\
     \vdots \\
     z_{p,|P_p|,|r_{|P_p|}|} \\
  \end{bmatrix}
\end{equation*}
%
Again, by assuming $\varepsilon \sim \mathcal{N}(0, \sigma^2)$ we construct an ordinary least squares estimator $\widehat{\vec{\beta}}_p $ for $\vec{\beta}_p$:
%
\begin{equation*}
  \widehat{\vec{\beta}}_p
  =
  {\left[
    \widehat{\beta}_{p,0},
    \widehat{\beta}_{p,x},
    \widehat{\beta}_{p,y}
  \right]}^T
  =
  \left( X_p^T X_p \right)^{-1} X_p^T \vec{z}_p
\end{equation*}
%
Interpolated elevation values for arbitrary $(x, y)$ coordinate tuples can now be constructed:
%
\begin{equation*}
  \widehat{z} = \widehat{\beta}_{p,0} + \widehat{\beta}_{p,x} x + \widehat{\beta}_{p,y} y
\end{equation*}
%
Or as an alternative formulation, a linear predictor $\widehat{f}_z$ parametrized according to $\widehat{\vec{\beta}}_p$ can be constructed:
%
\begin{equation*}
  \widehat{f}_z\left(x, y; \widehat{\vec{\beta}}_p\right)
  =
    \widehat{\beta}_{p,0}
    + \widehat{\beta}_{p,x} x
    + \widehat{\beta}_{p,y} y
  =
  \widehat{z}
\end{equation*}
%
Now define the coefficient vector set $\mathcal{B}(x, y)$ which contains all coefficient vectors to polygons that contain the coordinate $(x, y)$ when projected into the $xy$-plane.
More formally,
%
\begin{equation*}
  \mathcal{B}(x, y) = \left\{
    \vec{\beta}_p
    \mid
    (x, y) \in \pi_{\mathrm{2D}}(P_p)
  \right\},
\end{equation*}
%
where $\pi_{\mathrm{2D}}$ is the projection of all polygon vertex coordinates into the $xy$-plane as illustrated in \cref{fig:2d-polygon-projection}.
%
\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{2d-projection}
  \caption{%
    Projection of three-dimensional polygon onto $xy$-plane by $\pi_{\mathrm{2D}}$.
  }{%
    The three-dimensional polygon is shown in \textcolor{red}{red}, while the two-dimensional projection is shown in \textcolor{blue}{blue}.
  }%
  \label{fig:2d-polygon-projection}
\end{figure}
%
\begin{equation*}
  \vec{\beta}_m(x, y)
  =
  \argmax_{\vec{\beta} \in \mathcal{B}(x, y)}
    \widehat{f}_z(x, y; \vec{\beta})
\end{equation*}
%
\begin{equation*}
  \vec{n}\left(\vec{\beta}\right)
  =
  \frac{%
    1
  }{%
    \sqrt{\beta_x^2 + \beta_y^2 + 1}
  }
  \cdot
  {\left[
    -\beta_{x}, -\beta_{y}, 1
  \right]}^T
\end{equation*}


\begin{figure}
  \centering
  \includegraphics[width=\linewidth]{interpolation-concepts}
  \caption{Three-dimensional surface raster values}{%
    Illustration of interpolated altitude values, $Z_{ij}$, and respective surface normal vectors, $N_{ij}$.
    Slice for $i = 1$ and $1 \leq j \leq 4$.
  }
\end{figure}

\begin{algorithm}{Surface interpolation}{alg:surface-interpolation}{Tile bounding box $B(\vec{c}, w, h)$,\\Raster dimensions $H \times W$,\\R-Tree indexed polygon collection.}
\item Construct arrays with temporary placeholder values:
  \begin{itemize}[label=--,leftmargin=0cm]
    \item Normal vector array $N$ of size $H \times W \times 3$ filled with $0$.
    \item Interpolated elevation array $Z$ of size $H \times W \times 1$ filled with $-\infty$.
  \end{itemize}
\item Construct polygon collection $\mathcal{P}$ for given tile extents using R-Tree index.
  Convert polygons to pixel coordinate system.
\item For polygon $P_p = [r_{p0}, r_{p1}, \dots, r_{pn_p}]$ with a single exterior ring, $r_{p0}$, and $n_p$ interior rings, $[r_{p1}, \ldots, r_{pn_p}]$, in polygon collection $\mathcal{P}$.
  \begin{enumerate}[leftmargin=0.5em,label=\textbf{\alph*}]
      % \item The linear ring $r_{pj} = [(x_{pj0}, y_{pj0}, z_{ij0}), \dots, (x_{pjn_{ij}}, y_{ijn_{pj}}, z_{ijn_{pj}})]$.
    \item Construct $M \times 3$ design matrix $X$ populated with pixel coordinates of all \textit{unique} xy-vertices $(1, x_{pij}, y_{pij})$.
        Secondly, construct $M \times 1$ response vector $\vec{y}$ populated with the respective $z_{pij}$ coordinates.
    \item Solve linear regression problem $\vec{\beta}_p = {\left(\beta_0, \beta_x, \beta_y\right)}^T = {\left(X^T X\right)}^{-1} X^T \vec{y}$
    \item Construct polygon surface normal vector $\vec{n}_p$,
      \begin{equation*}
        \vec{n}_p \assign {\left(\beta_x^2 + \beta_y^2 + 1\right)}^{-1/2} \cdot {\left(-\beta_x, -\beta_y, 1\right)}^T,
      \end{equation*}
      where $||\vec{n}_p||_2 = 1$ by construction.
    \item For each pixel coordinate $(i, j)$ contained by the polygon $P_p$ projected onto the 2-dimensional pixel index plane:
      \begin{itemize}[leftmargin=0.5em]
        \item $h \assign \beta_0 + \beta_x j + \beta_y i$. If $h < Z_ij$, continue loop, else\dots
        \item $Z_{ij} \assign h$ and $\left(N_{ijx}, N_{ijy}, N_{ijz}\right) \assign \vec{n}_p$.
      \end{itemize}
    \end{enumerate}
\end{algorithm}
